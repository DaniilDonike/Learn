[[Дата-пайплайны для автоматизации дашбордов]]

На практике исходные данные для анализа хранят в базах. Чаще всего, это **необработанные логи** — журналы событий.

Объёмы логов огромны. Постоянные запросы к ним нагружают базу, замедляют работу систем и занимают очень много времени. Чем чаще вы обращаетесь к сырым логам напрямую, тем чаще администраторы базы данных смотрят на вас волком в очереди у кофе-машины.

К счастью, аналитику сырые данные нужны редко: для отчётов и выводов хватает агрегированных. **Агрегирование** или **агрегация** — процесс группировки и уменьшения размера данных. Например, в логах системы хранят информацию за последние 6 месяцев: 60 миллионов записей о каждом визите пользователей из 10 стран на сайт интернет-магазина. Ваша задача — ежемесячно строить отчёт с ответом на вопрос: сколько всего посетителей в месяц с разбивкой по странам.

Чтение 60 миллионов записей из БД может занимать часы! Лучше завести новую таблицу, в которую сохранять данные, уже сгруппированные по месяцу и стране. Размер такой таблицы: `6 месяцев х 10 стран = 60 записей`. Количество данных уменьшили в миллион раз — подготовка отчёта займёт секунды вместо часов.

Чтобы сохранить агрегированные данные, в psql создают таблицу командой **CREATE TABLE** (англ. «создать таблицу»). Вот её синтаксис:

Скопировать кодSQL

``` sql
CREATE TABLE имя_таблицы (
    первичный_ключ тип_данных,
    имя_столбца1 тип_данных,
    имя_столбца2 тип_данных,
    …); 
```

В PostgreSQL много типов данных. Нам понадобятся базовые:

- **INT** — целое число;
- **REAL** — число с плавающей точкой;
- **VARCHAR(n)** — строка, где n — её максимальная длина. Например, `VARCHAR(128)` задаёт поле, содержащее строку не длиннее 128 символов;
- **TIMESTAMP** — дата и время;
- **SERIAL** (англ. «порядковый») — специальный тип данных для значений первичных ключей. Напомним, первичным ключом называют уникальный номер записи в таблице. Первичный ключ обозначают выражением

```sql
CREATE TABLE имя_таблицы (название поля с первичным ключом serial PRIMARY KEY);  
```

При добавлении в таблицу новой записи, СУБД сама проставляет в поле типа SERIAL номер строки на единицу больше, чем номер предыдущей вставленной строки.

Возьмём знакомые данные об игровой индустрии. Теперь они в базе данных в таблице `data_raw`. Вот её структура:

|Поле|Тип данных|Описание|
|---|---|---|
|game_id|SERIAL|Первичный ключ|
|name|VARCHAR(1024)|Название игры|
|platform|VARCHAR(128)|Игровая платформа|
|year_of_release|VARCHAR(128)|Год выпуска|
|genre|VARCHAR(128)|Жанр игры|
|na_players|VARCHAR(128)|Количество продаж в Северной Америке|
|eu_players|VARCHAR(128)|Количество продаж в Европе|
|jp_players|VARCHAR(128)|Количество продаж в Японии|
|other_players|VARCHAR(128)|Количество продаж в остальном мире|
|critic_score|VARCHAR(128)|Оценка критиков|
|user_score|VARCHAR(128)|Оценка игроков|
|rating|VARCHAR(128)|Возрастной рейтинг|

Все поля таблицы строкового типа, потому что даже в числовых могут быть ошибочные данные. Задача автоматизации — приводить данные к нужным типам.

